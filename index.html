<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for modals */
        .max-h-\[70vh\]::-webkit-scrollbar {
            width: 8px;
        }
        .max-h-\[70vh\]::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .max-h-\[70vh\]::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .max-h-\[70vh\]::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Custom scrollbar for funnel columns */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #707070;
        }
    </style>
</head>
<body>
    <div id="root"></div> 
    <script type="text/babel">
        // Your React code goes here
        const { useState, useEffect, createContext, useContext, useCallback } = React;

        // Context for Supabase and User
        const AppContext = createContext(null);

        const AppProvider = ({ children }) => {
            const [supabase, setSupabase] = useState(null);
            const [userId, setUserId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            /*
             * ВАЖНО: Ошибка 401 (Unauthorized) обычно означает, что у пользователя
             * (даже анонимного, который создается при signInAnonymously)
             * нет необходимых разрешений для доступа к таблицам в Supabase.
             *
             * Это контролируется **Политиками Безопасности на Уровне Строк (Row Level Security - RLS)**
             * в вашей базе данных Supabase.
             *
             * Чтобы это приложение работало, вам нужно настроить RLS-политики
             * в панели управления Supabase для каждой таблицы (public.user, public.contacts,
             * public.deal_statuses, public.deals, public.interactions, public.integrations,
             * public.deal_audit_logs, public.tags, public.deal_tags, public.tasks).
             *
             * Пример политик, которые вам могут понадобиться:
             *
             * 1. Для таблиц, где пользователи видят только свои данные (contacts, deals, interactions, integrations, deal_audit_logs, tags, deal_tags, tasks):
             * - Включите RLS для таблицы.
             * - Создайте политику "SELECT":
             * Name: "Allow users to read their own data"
             * For: SELECT
             * Using expression: auth.uid() = user_id  (или owner_id для таблицы deals, или assigned_to_user_id для tasks)
             * Roles: authenticated, anon (если вы хотите, чтобы анонимные пользователи могли видеть свои данные)
             * - Создайте политику "INSERT":
             * Name: "Allow users to insert their own data"
             * For: INSERT
             * With check expression: auth.uid() = user_id (или owner_id, или assigned_to_user_id)
             * Roles: authenticated, anon
             * - Создайте политику "UPDATE":
             * Name: "Allow users to update their own data"
             * For: UPDATE
             * Using expression: auth.uid() = user_id (или owner_id, или assigned_to_user_id)
             * With check expression: auth.uid() = user_id (или owner_id, или assigned_to_user_id)
             * Roles: authenticated, anon
             * - Создайте политику "DELETE":
             * Name: "Allow users to delete their own data"
             * For: DELETE
             * Using expression: auth.uid() = user_id (или owner_id, или assigned_to_user_id)
             * Roles: authenticated, anon
             *
             * 2. Для таблицы `deal_statuses` (если она содержит общие данные для всех):
             * - Включите RLS для таблицы.
             * - Создайте политику "SELECT":
             * Name: "Allow all users to read deal statuses"
             * For: SELECT
             * Using expression: true
             * Roles: public, authenticated, anon
             *
             * 3. Для таблицы `public.user` (если она используется для профилей, связанных с Supabase Auth):
             * - Включите RLS для таблицы.
             * - Создайте политику "SELECT": `auth.uid() = id`
             * - Создайте политику "INSERT": `auth.uid() = id`
             * - Создайте политику "UPDATE": `auth.uid() = id`
             *
             * Убедитесь, что `user_id` (или `owner_id` в таблице `deals`, или `assigned_to_user_id` в `tasks`) в ваших таблицах
             * соответствует `auth.uid()` текущего пользователя.
             *
             * Ошибка `AuthRetryableFetchError` со статусом `0` обычно указывает на проблемы с сетью,
             * такие как блокировка CORS, проблемы с брандмауэром/прокси, или если проект Supabase
             * неактивен/приостановлен. Убедитесь, что ваш проект Supabase активен и домен,
             * с которого вы запускаете приложение (например, GitHub Pages URL),
             * добавлен в список разрешенных доменов CORS в настройках вашего проекта Supabase (Project Settings -> API).
             */

            // Функция для инициализации Supabase клиента
            // Обернуто в useCallback, чтобы обеспечить стабильную ссылку
            const initializeSupabaseClient = useCallback(async () => {
                console.log("Supabase: Попытка инициализации клиента...");
                try {
                    const supabaseUrl = 'https://kbjlqmzeclrtowtygbvu.supabase.co';
                    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtiamxxbXplY2xydG93dHlnYnZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4NTU2ODksImV4cCI6MjA2MzQzMTY4OX0.17nwxPRZnSMzwSbtAo83bxFEFWP5rdhjhUNuxxLLGP8';

                    if (!supabaseUrl || !supabaseAnonKey) {
                        setError("Supabase URL или Anon Key отсутствуют. Пожалуйста, убедитесь, что они предоставлены.");
                        setLoading(false);
                        console.error("Supabase: Отсутствуют URL или Anon Key.");
                        return;
                    }
                    console.log("Supabase: URL и Anon Key присутствуют.");

                    // Проверяем, доступен ли createClient из глобального объекта window
                    if (!window.supabase || !window.supabase.createClient) {
                        setError("Библиотека клиента Supabase не загружена в глобальный объект window. Пожалуйста, проверьте CDN-ссылку.");
                        setLoading(false);
                        console.error("Supabase: window.supabase.createClient не найден. Возможно, проблема с загрузкой CDN.");
                        return;
                    }
                    console.log("Supabase: window.supabase.createClient доступен.");

                    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                    setSupabase(supabaseClient);
                    console.log("Supabase: Клиент создан.");

                    // Попытка получить текущую сессию или войти анонимно
                    console.log("Supabase: Попытка получить сессию или войти анонимно...");
                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    if (sessionError) {
                        console.error("Supabase: Ошибка при получении сессии:", sessionError);
                        // Специальная обработка для ошибки "Invalid API key"
                        if (sessionError.message && sessionError.message.includes("Invalid API key")) {
                            setError("Недействительный API-ключ Supabase. Пожалуйста, перепроверьте ключ в настройках проекта Supabase (API Project Settings).");
                        } else {
                            setError("Ошибка при получении сессии Supabase: " + sessionError.message);
                        }
                        setLoading(false);
                        return; // Выходим после ошибки
                    }

                    if (session) {
                        setUserId(session.user.id);
                        console.log("Supabase: Пользователь вошел в систему с ID:", session.user.id);
                    } else {
                        // Вход анонимно, если сессия не найдена
                        console.log("Supabase: Сессия не найдена, попытка анонимного входа...");
                        const { data, error: signInError } = await supabaseClient.auth.signInAnonymously();
                        if (signInError) {
                            console.error("Supabase: Ошибка при анонимном входе:", signInError);
                             // Специальная обработка для ошибки "Invalid API key"
                            if (signInError.message && signInError.message.includes("Invalid API key")) {
                                setError("Недействительный API-ключ Supabase. Пожалуйста, перепроверьте ключ в настройках проекта Supabase (API Project Settings).");
                            } else {
                                setError("Ошибка при анонимном входе в Supabase: " + signInError.message);
                            }
                            setLoading(false);
                            return; // Выходим после ошибки
                        }
                        setUserId(data.user.id);
                        console.log("Supabase: Анонимный вход выполнен, ID пользователя:", data.user.id);
                    }

                    // Слушатель изменений состояния аутентификации
                    const { data: authListener } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                        if (session) {
                            setUserId(session.user.id);
                            console.log("Supabase: Состояние аутентификации изменилось, новый ID пользователя:", session.user.id);
                        } else {
                            setUserId(null); // Пользователь вышел или сессия завершилась
                            console.log("Supabase: Пользователь вышел из системы.");
                        }
                    });

                    setLoading(false);
                    console.log("Supabase: Инициализация завершена.");

                    // Очистка подписки при размонтировании компонента
                    return () => {
                        authListener?.subscription.unsubscribe();
                        console.log("Supabase: Отписка от слушателя аутентификации.");
                    };
                } catch (err) {
                    console.error("Ошибка инициализации Supabase (catch блок):", err);
                    setError("Не удалось инициализировать Supabase: " + err.message);
                    setLoading(false);
                }
            }, [setSupabase, setUserId, setLoading, setError]); // Зависимости useCallback

            useEffect(() => {
                // Вспомогательная функция, которая будет рекурсивно вызываться
                const loadSupabaseAndInitializeInternal = () => {
                    // Проверяем наличие createClient в глобальном объекте window
                    if (window.supabase && window.supabase.createClient) {
                        console.log("Клиент Supabase найден в объекте window. Инициализация...");
                        initializeSupabaseClient(); // Вызываем фактическую функцию инициализации
                    } else {
                        console.log("Клиент Supabase еще не доступен, повторяем попытку...");
                        // Важно передать loadSupabaseAndInitializeInternal, чтобы setTimeout вызывал сам себя
                        setTimeout(loadSupabaseAndInitializeInternal, 100); 
                    }
                };

                // Начинаем опрос для клиента Supabase
                loadSupabaseAndInitializeInternal();

                // Очистка не требуется для опроса, так как он останавливается после инициализации
            }, [initializeSupabaseClient]); // Зависит от initializeSupabaseClient
            // NOTE: Если initializeSupabaseClient не обернут в useCallback,
            // этот useEffect будет перезапускаться при каждом рендере,
            // что может привести к бесконечным циклам или ошибкам.


            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100">
                        <div className="text-lg font-semibold text-gray-700">Загрузка CRM...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-red-100 text-red-700 p-4">
                        <div className="text-lg font-semibold">Ошибка: {error}</div>
                    </div>
                );
            }

            return (
                <AppContext.Provider value={{ supabase, userId }}>
                    {children}
                </AppContext.Provider>
            );
        };

        // --- Utility Components ---

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 relative transform transition-all duration-300 scale-100 opacity-100">
                        <h3 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">{title}</h3>
                        <button
                            type="button" // Добавлено type="button"
                            onClick={onClose}
                            className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl leading-none"
                            aria-label="Закрыть"
                        >
                            &times;
                        </button>
                        <div className="max-h-[70vh] overflow-y-auto pr-2">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const InputField = ({ label, id, type = 'text', value, onChange, placeholder = '' }) => (
            <div className="mb-4">
                <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">
                    {label}
                </label>
                <input
                    type={type}
                    id={id}
                    name={id}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-150 ease-in-out"
                />
            </div>
        );

        const SelectField = ({ label, id, value, onChange, options }) => (
            <div className="mb-4">
                <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">
                    {label}
                </label>
                <select
                    id={id}
                    name={id}
                    value={value}
                    onChange={onChange}
                    className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-150 ease-in-out"
                >
                    {options.map(option => (
                        <option key={option.value} value={option.value}>
                            {option.label}
                        </option>
                    ))}
                </select>
            </div>
        );

        const TextAreaField = ({ label, id, value, onChange, placeholder = '' }) => (
            <div className="mb-4">
                <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">
                    {label}
                </label>
                <textarea
                    id={id}
                    name={id}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    rows="4"
                    className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-150 ease-in-out"
                ></textarea>
            </div>
        );

        // --- Pages/Components ---

        const DealForm = ({ deal, contacts, statuses, tags, onSave, onClose }) => {
            const [formData, setFormData] = useState(deal || {
                name: '',
                amount: '',
                status_id: '',
                owner_id: '', // This should be current user's ID
                close_date: '',
                contact_ids: [], // For linking contacts
                tag_ids: [] // For linking tags
            });

            useEffect(() => {
                if (deal) {
                    setFormData({
                        ...deal,
                        close_date: deal.close_date ? new Date(deal.close_date).toISOString().split('T')[0] : '',
                        contact_ids: deal.contact_ids || [],
                        tag_ids: deal.tag_ids || [] // Initialize tag_ids from deal
                    });
                }
            }, [deal]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleContactChange = (e) => {
                const { options } = e.target;
                const selectedContacts = Array.from(options)
                    .filter(option => option.selected)
                    .map(option => option.value);
                setFormData(prev => ({ ...prev, contact_ids: selectedContacts }));
            };

            const handleTagChange = (e) => {
                const { options } = e.target;
                const selectedTags = Array.from(options)
                    .filter(option => option.selected)
                    .map(option => option.value);
                setFormData(prev => ({ ...prev, tag_ids: selectedTags }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <InputField label="Название сделки" id="name" value={formData.name} onChange={handleChange} placeholder="Название сделки" />
                    <InputField label="Сумма" id="amount" type="number" value={formData.amount} onChange={handleChange} placeholder="0.00" />
                    <SelectField
                        label="Статус"
                        id="status_id"
                        value={formData.status_id}
                        onChange={handleChange}
                        options={[{ value: '', label: 'Выберите статус' }, ...statuses.map(s => ({ value: s.id, label: s.name }))]}
                    />
                    <InputField label="Дата закрытия" id="close_date" type="date" value={formData.close_date} onChange={handleChange} />

                    <div className="mb-4">
                        <label htmlFor="contact_ids" className="block text-sm font-medium text-gray-700 mb-1">
                            Связанные контакты
                        </label>
                        <select
                            id="contact_ids"
                            name="contact_ids"
                            multiple
                            value={formData.contact_ids}
                            onChange={handleContactChange}
                            className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-150 ease-in-out h-32"
                        >
                            {contacts.map(contact => (
                                <option key={contact.id} value={contact.id}>
                                    {contact.first_name} {contact.last_name} ({contact.company})
                                </option>
                            ))}
                        </select>
                    </div>

                    <div className="mb-4">
                        <label htmlFor="tag_ids" className="block text-sm font-medium text-gray-700 mb-1">
                            Теги
                        </label>
                        <select
                            id="tag_ids"
                            name="tag_ids"
                            multiple
                            value={formData.tag_ids}
                            onChange={handleTagChange}
                            className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-150 ease-in-out h-32"
                        >
                            {tags.map(tag => (
                                <option key={tag.id} value={tag.id}>
                                    {tag.name}
                                </option>
                            ))}
                        </select>
                    </div>

                    <div className="flex justify-end space-x-3 mt-6">
                        <button
                            type="button"
                            onClick={onClose}
                            className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150 ease-in-out"
                        >
                            Отмена
                        </button>
                        <button
                            type="submit"
                            className="px-6 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out"
                        >
                            Сохранить сделку
                        </button>
                    </div>
                </form>
            );
        };

        const ContactForm = ({ contact, onSave, onClose }) => {
            const [formData, setFormData] = useState(contact || {
                first_name: '',
                last_name: '',
                email: '',
                phone: '',
                company: '',
                title: ''
            });

            useEffect(() => {
                if (contact) {
                    setFormData(contact);
                }
            }, [contact]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <InputField label="Имя" id="first_name" value={formData.first_name} onChange={handleChange} placeholder="Имя" />
                    <InputField label="Фамилия" id="last_name" value={formData.last_name} onChange={handleChange} placeholder="Фамилия" />
                    <InputField label="Email" id="email" type="email" value={formData.email} onChange={handleChange} placeholder="email@example.com" />
                    <InputField label="Телефон" id="phone" value={formData.phone} onChange={handleChange} placeholder="+371XXXXXXXX" />
                    <InputField label="Компания" id="company" value={formData.company} onChange={handleChange} placeholder="Название компании" />
                    <InputField label="Должность" id="title" value={formData.title} onChange={handleChange} placeholder="Должность" />

                    <div className="flex justify-end space-x-3 mt-6">
                        <button
                            type="button"
                            onClick={onClose}
                            className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150 ease-in-out"
                        >
                            Отмена
                        </button>
                        <button
                            type="submit"
                            className="px-6 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out"
                        >
                            Сохранить контакт
                        </button>
                    </div>
                </form>
            );
        };

        const DealsPage = () => {
            const { supabase, userId } = useContext(AppContext);
            const [deals, setDeals] = useState([]);
            const [contacts, setContacts] = useState([]);
            const [statuses, setStatuses] = useState([]);
            const [tags, setTags] = useState([]); // New state for tags
            const [isDealModalOpen, setIsDealModalOpen] = useState(false);
            const [editingDeal, setEditingDeal] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [dealToDelete, setDealToDelete] = useState(null);
            const [filterStatus, setFilterStatus] = useState('all');

            const { setCurrentPage, setSelectedDealId } = useContext(AppRouterContext);

            useEffect(() => {
                if (!supabase || !userId) return;

                // --- Real-time subscription for statuses ---
                const statusesChannel = supabase.channel('deal_statuses_changes_deals_page')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'deal_statuses' },
                        payload => {
                            console.log("Real-time update for deal_statuses:", payload);
                            supabase.from('deal_statuses').select('*').order('order_index')
                                .then(({ data, error }) => {
                                    if (error) console.error("Error re-fetching statuses:", error);
                                    else setStatuses(data);
                                });
                        }
                    )
                    .subscribe();

                // Initial fetch for statuses
                supabase.from('deal_statuses').select('*').order('order_index')
                    .then(({ data, error }) => {
                        if (error) console.error("Error fetching initial statuses:", error);
                        else setStatuses(data);
                    });

                // --- Real-time subscription for contacts ---
                const contactsChannel = supabase.channel('contacts_changes_deals_page')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'contacts' },
                        payload => {
                            console.log("Real-time update for contacts on DealsPage:", payload);
                            supabase.from('contacts').select('*').eq('user_id', userId)
                                .then(({ data, error }) => {
                                    if (error) console.error("Error re-fetching contacts:", error);
                                    else setContacts(data);
                                });
                        }
                    )
                    .subscribe();

                // Initial fetch for contacts
                supabase.from('contacts').select('*').eq('user_id', userId)
                    .then(({ data, error }) => {
                        if (error) console.error("Error fetching initial contacts:", error);
                        else setContacts(data);
                    });

                // --- Real-time subscription for tags ---
                const tagsChannel = supabase.channel('tags_changes_deals_page')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'tags' },
                        payload => {
                            console.log("Real-time update for tags on DealsPage:", payload);
                            supabase.from('tags').select('*').or(`user_id.eq.${userId},user_id.is.null`) // Fetch user-specific or global tags
                                .then(({ data, error }) => {
                                    if (error) console.error("Error re-fetching tags:", error);
                                    else setTags(data);
                                });
                        }
                    )
                    .subscribe();

                // Initial fetch for tags
                supabase.from('tags').select('*').or(`user_id.eq.${userId},user_id.is.null`)
                    .then(({ data, error }) => {
                        if (error) console.error("Error fetching initial tags:", error);
                        else setTags(data);
                    });


                // --- Real-time subscription for deals ---
                const dealsChannel = supabase.channel('deals_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'deals' },
                        async payload => {
                            console.log("Real-time update for deals:", payload);
                            const { data: fetchedDeals, error } = await supabase
                                .from('deals')
                                .select('*')
                                .eq('owner_id', userId);

                            if (error) {
                                console.error("Error re-fetching deals:", error);
                                return;
                            }

                            // Fetch linked contacts and tags for each deal
                            const dealsWithRelatedData = await Promise.all(fetchedDeals.map(async (deal) => {
                                const linkedContacts = (deal.contact_ids && deal.contact_ids.length > 0)
                                    ? (await supabase.from('contacts').select('id, first_name, last_name, company').in('id', deal.contact_ids)).data || []
                                    : [];
                                
                                // Fetch tags linked via deal_tags table
                                const { data: dealTagsData, error: dealTagsError } = await supabase
                                    .from('deal_tags')
                                    .select('tag_id, tags(id, name)') // Select tag_id and join tags table to get name
                                    .eq('deal_id', deal.id);

                                if (dealTagsError) {
                                    console.error("Error fetching linked tags for deal:", dealTagsError);
                                }
                                
                                const linkedTags = dealTagsData ? dealTagsData.map(dt => dt.tags) : [];

                                return { ...deal, linkedContacts: linkedContacts, linkedTags: linkedTags };
                            }));
                            setDeals(dealsWithRelatedData);
                        }
                    )
                    .subscribe();

                // Initial fetch for deals
                supabase.from('deals').select('*').eq('owner_id', userId)
                    .then(async ({ data: fetchedDeals, error }) => {
                        if (error) {
                            console.error("Error fetching initial deals:", error);
                            return;
                        }
                        const dealsWithRelatedData = await Promise.all(fetchedDeals.map(async (deal) => {
                            const linkedContacts = (deal.contact_ids && deal.contact_ids.length > 0)
                                ? (await supabase.from('contacts').select('id, first_name, last_name, company').in('id', deal.contact_ids)).data || []
                                : [];

                            const { data: dealTagsData, error: dealTagsError } = await supabase
                                .from('deal_tags')
                                .select('tag_id, tags(id, name)')
                                .eq('deal_id', deal.id);

                            if (dealTagsError) {
                                console.error("Error fetching linked tags for deal:", dealTagsError);
                            }
                            const linkedTags = dealTagsData ? dealTagsData.map(dt => dt.tags) : [];
                            
                            return { ...deal, linkedContacts: linkedContacts, linkedTags: linkedTags };
                        }));
                        setDeals(dealsWithRelatedData);
                    });


                return () => {
                    statusesChannel.unsubscribe();
                    contactsChannel.unsubscribe();
                    tagsChannel.unsubscribe(); // Unsubscribe from tags channel
                    dealsChannel.unsubscribe();
                };
            }, [supabase, userId]); // Depend on supabase and userId

            const handleSaveDeal = async (dealData) => {
                try {
                    const { tag_ids, ...dealFields } = dealData; // Extract tag_ids
                    const dealToSave = {
                        name: dealFields.name,
                        amount: parseFloat(dealFields.amount),
                        status_id: dealFields.status_id,
                        owner_id: userId,
                        close_date: dealFields.close_date || null,
                        contact_ids: dealFields.contact_ids || [], 
                    };

                    let currentDealId = editingDeal ? editingDeal.id : null;

                    if (editingDeal) {
                        // Update existing deal
                        const { error } = await supabase
                            .from('deals')
                            .update(dealToSave)
                            .eq('id', editingDeal.id);
                        if (error) throw error;
                        console.log("Сделка обновлена:", editingDeal.id);
                    } else {
                        // Add new deal
                        const { data, error } = await supabase
                            .from('deals')
                            .insert(dealToSave)
                            .select('id'); // Select the ID of the newly inserted deal
                        if (error) throw error;
                        currentDealId = data[0].id; // Get the ID of the new deal
                        console.log("Новая сделка добавлена с ID:", currentDealId);
                    }

                    // Handle tags (delete existing and insert new ones)
                    if (currentDealId) {
                        // First, delete all existing tags for this deal
                        const { error: deleteTagsError } = await supabase
                            .from('deal_tags')
                            .delete()
                            .eq('deal_id', currentDealId);
                        if (deleteTagsError) console.error("Error deleting old deal tags:", deleteTagsError);

                        // Then, insert new tags
                        if (tag_ids && tag_ids.length > 0) {
                            const newDealTags = tag_ids.map(tagId => ({
                                deal_id: currentDealId,
                                tag_id: tagId
                            }));
                            const { error: insertTagsError } = await supabase
                                .from('deal_tags')
                                .insert(newDealTags);
                            if (insertTagsError) console.error("Error inserting new deal tags:", insertTagsError);
                        }
                    }

                    setIsDealModalOpen(false);
                    setEditingDeal(null);
                } catch (e) {
                    console.error("Ошибка при сохранении сделки:", e);
                }
            };

            const handleEditDeal = (deal) => {
                setEditingDeal(deal);
                setIsDealModalOpen(true);
            };

            const handleDeleteClick = (deal) => {
                setDealToDelete(deal);
                setShowDeleteConfirm(true);
            };

            const confirmDeleteDeal = async () => {
                if (!dealToDelete) return;
                try {
                    const { error } = await supabase
                        .from('deals')
                        .delete()
                        .eq('id', dealToDelete.id);
                    if (error) throw error;
                    console.log("Сделка удалена:", dealToDelete.id);
                    setShowDeleteConfirm(false);
                    setDealToDelete(null);
                } catch (e) {
                    console.error("Ошибка при удалении сделки:", e);
                }
            };

            const handleViewDealDetails = (dealId) => {
                setSelectedDealId(dealId);
                setCurrentPage('dealDetails');
            };

            const getStatusName = (statusId) => {
                const status = statuses.find(s => s.id === statusId);
                return status ? status.name : 'Неизвестный статус';
            };

            const getStatusColor = (statusId) => {
                const status = statuses.find(s => s.id === statusId);
                return status ? status.color : '#6B7280'; // Default gray
            };

            const filteredDeals = deals.filter(deal => {
                if (filterStatus === 'all') return true;
                return deal.status_id === filterStatus;
            });

            return (
                <div className="p-6 bg-gray-50 min-h-screen rounded-lg shadow-inner">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-extrabold text-gray-900">Сделки</h2>
                        <div className="flex items-center space-x-4">
                            <SelectField
                                id="statusFilter"
                                value={filterStatus}
                                onChange={(e) => setFilterStatus(e.target.value)}
                                options={[{ value: 'all', label: 'Все статусы' }, ...statuses.map(s => ({ value: s.id, label: s.name }))]}
                            />
                            <button
                                onClick={() => { setEditingDeal(null); setIsDealModalOpen(true); }}
                                className="px-6 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out flex items-center"
                            >
                                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Новая сделка
                            </button>
                        </div>
                    </div>

                    {filteredDeals.length === 0 ? (
                        <p className="text-center text-gray-600 text-lg mt-10">Пока нет сделок. Создай первую!</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredDeals.map(deal => (
                                <div key={deal.id} className="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                                    <div className="p-6">
                                        <div className="flex justify-between items-start mb-3">
                                            <h3 className="text-xl font-bold text-gray-800">{deal.name}</h3>
                                            <span
                                                className="px-3 py-1 rounded-full text-xs font-semibold"
                                                style={{ backgroundColor: getStatusColor(deal.status_id), color: 'white' }}
                                            >
                                                {getStatusName(deal.status_id)}
                                            </span>
                                        </div>
                                        <p className="text-gray-600 mb-2">Сумма: <span className="font-semibold text-lg text-green-700">${deal.amount?.toFixed(2)}</span></p>
                                        <p className="text-gray-600 mb-2">
                                            Дата закрытия: {deal.close_date ? new Date(deal.close_date).toLocaleDateString() : 'N/A'}
                                        </p>
                                        {deal.linkedContacts && deal.linkedContacts.length > 0 && (
                                            <div className="mt-3">
                                                <p className="text-sm font-medium text-gray-700 mb-1">Контакты:</p>
                                                <ul className="list-disc list-inside text-gray-600 text-sm">
                                                    {deal.linkedContacts.map(contact => (
                                                        <li key={contact.id}>{contact.first_name} {contact.last_name} ({contact.company})</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                        {deal.linkedTags && deal.linkedTags.length > 0 && (
                                            <div className="mt-3">
                                                <p className="text-sm font-medium text-gray-700 mb-1">Теги:</p>
                                                <div className="flex flex-wrap gap-2">
                                                    {deal.linkedTags.map(tag => (
                                                        <span key={tag.id} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                                                            {tag.name}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="bg-gray-50 border-t border-gray-100 px-6 py-4 flex justify-end space-x-2">
                                        <button
                                            onClick={() => handleViewDealDetails(deal.id)}
                                            className="text-gray-600 hover:text-gray-800 font-medium text-sm px-3 py-1 rounded-lg hover:bg-gray-100 transition duration-150"
                                        >
                                            Детали
                                        </button>
                                        <button
                                            onClick={() => handleEditDeal(deal)}
                                            className="text-indigo-600 hover:text-indigo-800 font-medium text-sm px-3 py-1 rounded-lg hover:bg-indigo-50 transition duration-150"
                                        >
                                            Редактировать
                                        </button>
                                        <button
                                            onClick={() => handleDeleteClick(deal)}
                                            className="text-red-600 hover:text-red-800 font-medium text-sm px-3 py-1 rounded-lg hover:bg-red-50 transition duration-150"
                                >
                                            Удалить
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    <Modal isOpen={isDealModalOpen} onClose={() => setIsDealModalOpen(false)} title={editingDeal ? "Редактировать сделку" : "Новая сделка"}>
                        <DealForm
                            deal={editingDeal}
                            contacts={contacts}
                            statuses={statuses}
                            tags={tags} // Pass tags to DealForm
                            onSave={handleSaveDeal}
                            onClose={() => setIsDealModalOpen(false)}
                        />
                    </Modal>

                    <Modal isOpen={showDeleteConfirm} onClose={() => setIsDealModalOpen(false)} title="Подтверждение удаления">
                        <p className="text-gray-700 mb-6">Вы уверены, что хотите удалить сделку "{dealToDelete?.name}"? Это действие необратимо.</p>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={() => setShowDeleteConfirm(false)}
                                className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150"
                            >
                                Отмена
                            </button>
                            <button
                                type="button"
                                onClick={confirmDeleteDeal}
                                className="px-6 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out"
                            >
                                Удалить
                            </button>
                        </div>
                    </Modal>
                </div>
            );
        };

        const ContactsPage = () => {
            const { supabase, userId } = useContext(AppContext);
            const { setCurrentPage, setSelectedContactId } = useContext(AppRouterContext);
            const [contacts, setContacts] = useState([]);
            const [isContactModalOpen, setIsContactModalOpen] = useState(false);
            const [editingContact, setEditingContact] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [contactToDelete, setContactToDelete] = useState(null);


            useEffect(() => {
                if (!supabase || !userId) return;

                // --- Real-time subscription for contacts ---
                const contactsChannel = supabase.channel('contacts_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'contacts' },
                        payload => {
                            console.log("Real-time update for contacts:", payload);
                            supabase.from('contacts').select('*').eq('user_id', userId)
                                .then(({ data, error }) => {
                                    if (error) console.error("Error re-fetching contacts:", error);
                                    else setContacts(data);
                                });
                        }
                    )
                    .subscribe();

                // Initial fetch for contacts
                supabase.from('contacts').select('*').eq('user_id', userId)
                    .then(({ data, error }) => {
                        if (error) console.error("Error fetching initial contacts:", error);
                        else setContacts(data);
                    });

                return () => contactsChannel.unsubscribe();
            }, [supabase, userId]);

            const handleSaveContact = async (contactData) => {
                try {
                    // Ensure 'name' is derived from first_name and last_name if not explicitly set
                    const contactToSave = {
                        ...contactData,
                        name: `${contactData.first_name || ''} ${contactData.last_name || ''}`.trim(), // Derive 'name'
                        user_id: userId,
                    };

                    if (editingContact) {
                        // Update existing contact
                        const { error } = await supabase
                            .from('contacts')
                            .update(contactToSave)
                            .eq('id', editingContact.id); // Use 'id' for update
                        if (error) throw error;
                        console.log("Контакт обновлен:", editingContact.id);
                    } else {
                        // Add new contact
                        const { error } = await supabase
                            .from('contacts')
                            .insert(contactToSave);
                        if (error) throw error;
                        console.log("Новый контакт добавлен.");
                    }
                    setIsContactModalOpen(false);
                    setEditingContact(null);
                } catch (e) {
                    console.error("Ошибка при сохранении контакта:", e);
                }
            };

            const handleEditContact = (contact) => {
                setEditingContact(contact);
                setIsContactModalOpen(true);
            };

            const handleDeleteClick = (contact) => {
                setContactToDelete(contact);
                setShowDeleteConfirm(true);
            };

            const confirmDeleteContact = async () => {
                if (!contactToDelete) return;
                try {
                    const { error } = await supabase
                        .from('contacts')
                        .delete()
                        .eq('id', contactToDelete.id); // Use 'id' for delete
                    if (error) throw error;
                    console.log("Контакт удален:", contactToDelete.id);
                    setShowDeleteConfirm(false);
                    setContactToDelete(null);
                } catch (e) {
                    console.error("Ошибка при удалении контакта:", e);
                }
            };

            const handleViewContactDetails = (contactId) => {
                setSelectedContactId(contactId);
                setCurrentPage('contactDetails');
            };

            return (
                <div className="p-6 bg-gray-50 min-h-screen rounded-lg shadow-inner">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-extrabold text-gray-900">Контакты</h2>
                        <button
                            onClick={() => { setEditingContact(null); setIsContactModalOpen(true); }}
                            className="px-6 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out flex items-center"
                        >
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            Новый контакт
                        </button>
                    </div>

                    {contacts.length === 0 ? (
                        <p className="text-center text-gray-600 text-lg mt-10">Пока нет контактов. Добавь первый!</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {contacts.map(contact => (
                                <div key={contact.id} className="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                                    <div className="p-6">
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">{contact.first_name} {contact.last_name}</h3>
                                        <p className="text-gray-600 mb-1">Компания: <span className="font-semibold">{contact.company || 'N/A'}</span></p>
                                        <p className="text-gray-600 mb-1">Должность: {contact.title || 'N/A'}</p>
                                        <p className="text-gray-600 mb-1">Email: <a href={`mailto:${contact.email}`} className="text-indigo-600 hover:underline">{contact.email || 'N/A'}</a></p>
                                        <p className="text-gray-600">Телефон: <a href={`tel:${contact.phone}`} className="text-indigo-600 hover:underline">{contact.phone || 'N/A'}</a></p>
                                    </div>
                                    <div className="bg-gray-50 border-t border-gray-100 px-6 py-4 flex justify-end space-x-2">
                                        <button
                                            onClick={() => handleViewContactDetails(contact.id)}
                                            className="text-gray-600 hover:text-gray-800 font-medium text-sm px-3 py-1 rounded-lg hover:bg-gray-100 transition duration-150"
                                        >
                                            Детали
                                        </button>
                                        <button
                                            onClick={() => handleEditContact(contact)}
                                            className="text-indigo-600 hover:text-indigo-800 font-medium text-sm px-3 py-1 rounded-lg hover:bg-indigo-50 transition duration-150"
                                        >
                                            Редактировать
                                        </button>
                                        <button
                                            onClick={() => handleDeleteClick(contact)}
                                            className="text-red-600 hover:text-red-800 font-medium text-sm px-3 py-1 rounded-lg hover:bg-red-50 transition duration-150"
                                        >
                                            Удалить
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    <Modal isOpen={isContactModalOpen} onClose={() => setIsContactModalOpen(false)} title={editingContact ? "Редактировать контакт" : "Новый контакт"}>
                        <ContactForm
                            contact={editingContact}
                            onSave={handleSaveContact}
                            onClose={() => setIsContactModalOpen(false)}
                        />
                    </Modal>

                    <Modal isOpen={showDeleteConfirm} onClose={() => setIsContactModalOpen(false)} title="Подтверждение удаления">
                        <p className="text-gray-700 mb-6">Вы уверены, что хотите удалить контакт "{contactToDelete?.first_name} {contactToDelete?.last_name}"? Это действие необратимо.</p>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={() => setShowDeleteConfirm(false)}
                                className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150"
                            >
                                Отмена
                            </button>
                            <button
                                type="button"
                                onClick={confirmDeleteContact}
                                className="px-6 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out"
                            >
                                Удалить
                            </button>
                        </div>
                    </Modal>
                </div>
            );
        };

        const HistoryPage = () => {
            const { supabase, userId } = useContext(AppContext);
            const [interactions, setInteractions] = useState([]);
            const [deals, setDeals] = useState([]);
            const [contacts, setContacts] = useState([]);


            useEffect(() => {
                if (!supabase || !userId) return;

                const fetchRelatedData = async () => {
                    // Fetch deals
                    const { data: dealsData, error: dealsError } = await supabase
                        .from('deals')
                        .select('id, name')
                        .eq('owner_id', userId);
                    if (dealsError) console.error("Error fetching deals for history:", dealsError);
                    else setDeals(dealsData);

                    // Fetch contacts
                    const { data: contactsData, error: contactsError } = await supabase
                        .from('contacts')
                        .select('id, first_name, last_name')
                        .eq('user_id', userId);
                    if (contactsError) console.error("Error fetching contacts for history:", contactsError);
                    else setContacts(contactsData);
                };

                fetchRelatedData();

                // --- Real-time subscription for interactions ---
                const interactionsChannel = supabase.channel('interactions_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'interactions' },
                        payload => {
                            console.log("Real-time update for interactions:", payload);
                            supabase.from('interactions').select('*').eq('user_id', userId).order('interaction_date', { ascending: false })
                                .then(({ data, error }) => {
                                    if (error) console.error("Error re-fetching interactions:", error);
                                    else setInteractions(data);
                                });
                        }
                    )
                    .subscribe();

                // Initial fetch for interactions
                supabase.from('interactions').select('*').eq('user_id', userId).order('interaction_date', { ascending: false })
                    .then(({ data, error }) => {
                        if (error) console.error("Error fetching initial interactions:", error);
                        else setInteractions(data);
                    });

                return () => interactionsChannel.unsubscribe();
            }, [supabase, userId]);

            const getDealName = (dealId) => {
                const deal = deals.find(d => d.id === dealId);
                return deal ? deal.name : 'Неизвестная сделка';
            };

            const getContactName = (contactId) => {
                const contact = contacts.find(c => c.id === contactId);
                return contact ? `${contact.first_name} ${contact.last_name}` : 'Неизвестный контакт';
            };

            return (
                <div className="p-6 bg-gray-50 min-h-screen rounded-lg shadow-inner">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6">История взаимодействий</h2>

                    {interactions.length === 0 ? (
                        <p className="text-center text-gray-600 text-lg mt-10">Пока нет записей о взаимодействиях.</p>
                    ) : (
                        <div className="space-y-6">
                            {interactions.map(interaction => (
                                <div key={interaction.id} className="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300">
                                    <div className="flex justify-between items-center mb-3">
                                        <span className="text-lg font-semibold text-indigo-700">{interaction.type}</span>
                                        <span className="text-sm text-gray-500">
                                            {interaction.interaction_date ? new Date(interaction.interaction_date).toLocaleString() : 'N/A'}
                                        </span>
                                    </div>
                                    {(interaction.deal_id || interaction.contact_id) && (
                                        <div className="text-sm text-gray-600">
                                            {interaction.deal_id && (
                                                <p>Сделка: <span className="font-medium">{getDealName(interaction.deal_id)}</span></p>
                                            )}
                                            {interaction.contact_id && (
                                                <p>Контакт: <span className="font-medium">{getContactName(interaction.contact_id)}</span></p>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const IntegrationsPage = () => {
            const { supabase, userId } = useContext(AppContext);
            const [integrations, setIntegrations] = useState([]);
            const [isIntegrationModalOpen, setIsIntegrationModalOpen] = useState(false);
            const [editingIntegration, setEditingIntegration] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [integrationToDelete, setIntegrationToDelete] = useState(null);


            useEffect(() => {
                if (!supabase || !userId) return;

                // --- Real-time subscription for integrations ---
                const integrationsChannel = supabase.channel('integrations_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'integrations' },
                        payload => {
                            console.log("Real-time update for integrations:", payload);
                            supabase.from('integrations').select('*').eq('user_id', userId)
                                .then(({ data, error }) => {
                                    if (error) console.error("Error re-fetching integrations:", error);
                                    else setIntegrations(data);
                                });
                        }
                    )
                    .subscribe();

                // Initial fetch for integrations
                supabase.from('integrations').select('*').eq('user_id', userId)
                    .then(({ data, error }) => {
                        if (error) console.error("Error fetching initial integrations:", error);
                        else setIntegrations(data);
                    });

                return () => integrationsChannel.unsubscribe();
            }, [supabase, userId]);

            const handleSaveIntegration = async (integrationData) => {
                try {
                    const integrationToSave = {
                        ...integrationData,
                        user_id: userId,
                        // created_at and updated_at are handled by database defaults/triggers
                    };

                    if (editingIntegration) {
                        const { error } = await supabase
                            .from('integrations')
                            .update(integrationToSave)
                            .eq('id', editingIntegration.id);
                        if (error) throw error;
                        console.log("Интеграция обновлена:", editingIntegration.id);
                    } else {
                        const { error } = await supabase
                            .from('integrations')
                            .insert(integrationToSave);
                        if (error) throw error;
                        console.log("Новая интеграция добавлена.");
                    }
                    setIsIntegrationModalOpen(false);
                    setEditingIntegration(null);
                } catch (e) {
                    console.error("Ошибка при сохранении интеграции:", e);
                }
            };

            const handleEditIntegration = (integration) => {
                setEditingIntegration(integration);
                setIsIntegrationModalOpen(true);
            };

            const handleDeleteClick = (integration) => {
                setIntegrationToDelete(integration);
                setShowDeleteConfirm(true);
            };

            const confirmDeleteIntegration = async () => {
                if (!integrationToDelete) return;
                try {
                    const { error } = await supabase
                        .from('integrations')
                        .delete()
                        .eq('id', integrationToDelete.id);
                    if (error) throw error;
                    console.log("Интеграция удалена:", integrationToDelete.id);
                    setShowDeleteConfirm(false);
                    setIntegrationToDelete(null);
                } catch (e) {
                    console.error("Ошибка при удалении интеграции:", e);
                }
            };

            const IntegrationForm = ({ integration, onSave, onClose }) => {
                const [formData, setFormData] = useState(integration || {
                    name: '',
                    api_key: '',
                    config_json: '{}',
                    enabled: true
                });

                useEffect(() => {
                    if (integration) {
                        setFormData({
                            ...integration,
                            config_json: JSON.stringify(integration.config_json || {}, null, 2)
                        });
                    }
                }, [integration]);

                const handleChange = (e) => {
                    const { name, value, type, checked } = e.target;
                    setFormData(prev => ({
                        ...prev,
                        [name]: type === 'checkbox' ? checked : value
                    }));
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    try {
                        const parsedConfig = JSON.parse(formData.config_json);
                        onSave({ ...formData, config_json: parsedConfig });
                    } catch (error) {
                        console.error("Неверный формат JSON для конфигурации:", error);
                        // Using alert for simplicity, replace with custom modal
                        // In a real app, you'd use a custom modal for user feedback
                        alert("Ошибка: Неверный формат JSON для конфигурации.");
                    }
                };

                return (
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <InputField label="Название интеграции" id="name" value={formData.name} onChange={handleChange} placeholder="Например, WhatsApp Business API" />
                        <InputField label="Ключ API" id="api_key" type="password" value={formData.api_key} onChange={handleChange} placeholder="Ваш ключ API" />
                        <TextAreaField label="Конфигурация JSON" id="config_json" value={formData.config_json} onChange={handleChange} placeholder="{ &quot;webhook_url&quot;: &quot;...&quot; }" />
                        <div className="flex items-center mb-4">
                            <input
                                type="checkbox"
                                id="enabled"
                                name="enabled"
                                checked={formData.enabled}
                                onChange={handleChange}
                                className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                            />
                            <label htmlFor="enabled" className="ml-2 block text-sm text-gray-900">
                                Включить интеграцию
                            </label>
                        </div>

                        <div className="flex justify-end space-x-3 mt-6">
                            <button
                                type="button"
                                onClick={onClose}
                                className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150 ease-in-out"
                            >
                                Отмена
                            </button>
                            <button
                                type="submit"
                                className="px-6 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out"
                            >
                                Сохранить интеграцию
                            </button>
                        </div>
                    </form>
                );
            };

            return (
                <div className="p-6 bg-gray-50 min-h-screen rounded-lg shadow-inner">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-extrabold text-gray-900">Интеграции</h2>
                        <button
                            onClick={() => { setEditingIntegration(null); setIsIntegrationModalOpen(true); }}
                            className="px-6 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out flex items-center"
                        >
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            Новая интеграция
                        </button>
                    </div>

                    {integrations.length === 0 ? (
                        <p className="text-center text-gray-600 text-lg mt-10">Пока нет настроенных интеграций.</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {integrations.map(integration => (
                                <div key={integration.id} className="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                                    <div className="p-6">
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">{integration.name}</h3>
                                        <p className="text-gray-600 mb-1">Статус: <span className={`font-semibold ${integration.enabled ? 'text-green-600' : 'text-red-600'}`}>
                                            {integration.enabled ? 'Включена' : 'Отключена'}
                                        </span></p>
                                        <p className="text-gray-600 text-sm mt-3">
                                            Конфигурация: <pre className="bg-gray-100 p-2 rounded-lg text-xs overflow-auto">{JSON.stringify(integration.config_json, null, 2)}</pre>
                                        </p>
                                    </div>
                                    <div className="bg-gray-50 border-t border-gray-100 px-6 py-4 flex justify-end space-x-2">
                                        <button
                                            onClick={() => handleEditIntegration(integration)}
                                            className="text-indigo-600 hover:text-indigo-800 font-medium text-sm px-3 py-1 rounded-lg hover:bg-indigo-50 transition duration-150"
                                        >
                                            Редактировать
                                        </button>
                                        <button
                                            onClick={() => handleDeleteClick(integration)}
                                            className="text-red-600 hover:text-red-800 font-medium text-sm px-3 py-1 rounded-lg hover:bg-red-50 transition duration-150"
                                        >
                                            Удалить
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    <Modal isOpen={isIntegrationModalOpen} onClose={() => setIsIntegrationModalOpen(false)} title="Подтверждение удаления">
                        <p className="text-gray-700 mb-6">Вы уверены, что хотите удалить интеграцию "{integrationToDelete?.name}"? Это действие необратимо.</p>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={() => setShowDeleteConfirm(false)}
                                className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150"
                            >
                                Отмена
                            </button>
                            <button
                                type="button"
                                onClick={confirmDeleteIntegration}
                                className="px-6 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out"
                            >
                                Удалить
                            </button>
                        </div>
                    </Modal>
                </div>
            );
        };


        const DashboardPage = () => {
            const { supabase, userId } = useContext(AppContext);
            const [deals, setDeals] = useState([]);
            const [contacts, setContacts] = useState([]);
            const [interactions, setInteractions] = useState([]);
            const [statuses, setStatuses] = useState([]);


            useEffect(() => {
                if (!supabase || !userId) return;

                const fetchData = async () => {
                    try {
                        // Fetch deals
                        const { data: dealsData, error: dealsError } = await supabase
                            .from('deals')
                            .select('*')
                            .eq('owner_id', userId);
                        if (dealsError) console.error("Error fetching deals for dashboard:", dealsError);
                        else setDeals(dealsData);

                        // Fetch contacts
                        const { data: contactsData, error: contactsError } = await supabase
                            .from('contacts')
                            .select('*')
                            .eq('user_id', userId);
                        if (contactsError) console.error("Error fetching contacts for dashboard:", contactsError);
                        else setContacts(contactsData);

                        // Fetch interactions
                        const { data: interactionsData, error: interactionsError } = await supabase
                            .from('interactions')
                            .select('*')
                            .eq('user_id', userId);
                        if (interactionsError) console.error("Error fetching interactions for dashboard:", interactionsError);
                        else setInteractions(interactionsData);

                        // Fetch statuses
                        const { data: statusesData, error: statusesError } = await supabase
                            .from('deal_statuses')
                            .select('*')
                            .order('order_index');
                        if (statusesError) console.error("Error fetching statuses for dashboard:", statusesError);
                        else setStatuses(statusesData);

                    } catch (error) {
                        console.error("Error fetching dashboard data:", error);
                    }
                };

                fetchData();
            }, [supabase, userId]);

            const getTotalDeals = () => deals.length;
            const getTotalContacts = () => contacts.length;
            const getTotalInteractions = () => interactions.length;
            const getTotalDealValue = () => deals.reduce((sum, deal) => sum + (deal.amount || 0), 0).toFixed(2);

            const getDealsByStatus = () => {
                const counts = {};
                statuses.forEach(status => {
                    counts[status.name] = deals.filter(deal => deal.status_id === status.id).length;
                });
                return counts;
            };

            const statusCounts = getDealsByStatus();

            return (
                <div className="p-6 bg-gray-50 min-h-screen rounded-lg shadow-inner">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6">Панель управления</h2>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <StatCard title="Всего сделок" value={getTotalDeals()} icon="📊" />
                        <StatCard title="Общая сумма сделок" value={`$${getTotalDealValue()}`} icon="💰" />
                        <StatCard title="Всего контактов" value={getTotalContacts()} icon="👥" />
                        <StatCard title="Всего взаимодействий" value={getTotalInteractions()} icon="💬" />
                    </div>

                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-4">Сделки по статусам</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {statuses.map(status => (
                                <div key={status.id} className="p-4 rounded-lg flex items-center justify-between" style={{ backgroundColor: status.color, color: 'white' }}>
                                    <span className="font-semibold text-lg">{status.name}</span>
                                    <span className="text-2xl font-bold">{statusCounts[status.name] || 0}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, icon }) => (
            <div className="bg-white rounded-xl shadow-lg p-6 flex items-center space-x-4">
                <div className="text-5xl">{icon}</div>
                <div>
                    <p className="text-gray-500 text-sm">{title}</p>
                    <p className="text-3xl font-bold text-gray-900">{value}</p>
                </div>
            </div>
        );


        // --- New Funnel Page ---
        const FunnelPage = () => {
            const { supabase, userId } = useContext(AppContext);
            const { setCurrentPage, setSelectedDealId } = useContext(AppRouterContext);
            const [deals, setDeals] = useState([]);
            const [statuses, setStatuses] = useState([]);
            const [tags, setTags] = useState([]); // New state for tags
            const [isDealModalOpen, setIsDealModalOpen] = useState(false);
            const [editingDeal, setEditingDeal] = useState(null);
            const [contacts, setContacts] = useState([]); // Needed for DealForm

            // Fetch statuses and deals
            useEffect(() => {
                if (!supabase || !userId) return;

                // --- Real-time subscription for statuses ---
                const statusesChannel = supabase.channel('deal_statuses_changes_funnel_page')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'deal_statuses' },
                        payload => {
                            console.log("Real-time update for deal_statuses on FunnelPage:", payload);
                            supabase.from('deal_statuses').select('*').order('order_index')
                                .then(({ data, error }) => {
                                    if (error) console.error("Error re-fetching statuses for FunnelPage:", error);
                                    else setStatuses(data);
                                });
                        }
                    )
                    .subscribe();

                // Initial fetch for statuses
                supabase.from('deal_statuses').select('*').order('order_index')
                    .then(({ data, error }) => {
                        if (error) console.error("Error fetching initial statuses for FunnelPage:", error);
                        else setStatuses(data);
                    });

                // --- Real-time subscription for contacts ---
                const contactsChannel = supabase.channel('contacts_changes_funnel_page')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'contacts' },
                        payload => {
                            console.log("Real-time update for contacts on FunnelPage:", payload);
                            supabase.from('contacts').select('*').eq('user_id', userId)
                                .then(({ data, error }) => {
                                    if (error) console.error("Error re-fetching contacts for FunnelPage:", error);
                                    else setContacts(data);
                                });
                        }
                    )
                    .subscribe();

                // Initial fetch for contacts
                supabase.from('contacts').select('*').eq('user_id', userId)
                    .then(({ data, error }) => {
                        if (error) console.error("Error fetching initial contacts:", error);
                        else setContacts(data);
                    });

                // --- Real-time subscription for tags ---
                const tagsChannel = supabase.channel('tags_changes_funnel_page')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'tags' },
                        payload => {
                            console.log("Real-time update for tags on FunnelPage:", payload);
                            supabase.from('tags').select('*').or(`user_id.eq.${userId},user_id.is.null`)
                                .then(({ data, error }) => {
                                    if (error) console.error("Error re-fetching tags:", error);
                                    else setTags(data);
                                });
                        }
                    )
                    .subscribe();

                // Initial fetch for tags
                supabase.from('tags').select('*').or(`user_id.eq.${userId},user_id.is.null`)
                    .then(({ data, error }) => {
                        if (error) console.error("Error fetching initial tags:", error);
                        else setTags(data);
                    });


                // --- Real-time subscription for deals ---
                const dealsChannel = supabase.channel('deals_changes_funnel_page')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'deals' },
                        async payload => {
                            console.log("Real-time update for deals on FunnelPage:", payload);
                            const { data: fetchedDeals, error } = await supabase
                                .from('deals')
                                .select('*')
                                .eq('owner_id', userId);

                            if (error) {
                                console.error("Error re-fetching deals for FunnelPage:", error);
                                return;
                            }

                            const dealsWithRelatedData = await Promise.all(fetchedDeals.map(async (deal) => {
                                const linkedContacts = (deal.contact_ids && deal.contact_ids.length > 0)
                                    ? (await supabase.from('contacts').select('id, first_name, last_name, company').in('id', deal.contact_ids)).data || []
                                    : [];
                                
                                const { data: dealTagsData, error: dealTagsError } = await supabase
                                    .from('deal_tags')
                                    .select('tag_id, tags(id, name)')
                                    .eq('deal_id', deal.id);

                                if (dealTagsError) {
                                    console.error("Error fetching linked tags for deal:", dealTagsError);
                                }
                                const linkedTags = dealTagsData ? dealTagsData.map(dt => dt.tags) : [];

                                return { ...deal, linkedContacts: linkedContacts, linkedTags: linkedTags };
                            }));
                            setDeals(dealsWithRelatedData);
                        }
                    )
                    .subscribe();

                // Initial fetch for deals
                supabase.from('deals').select('*').eq('owner_id', userId)
                    .then(async ({ data: fetchedDeals, error }) => {
                        if (error) {
                            console.error("Error fetching initial deals for FunnelPage:", error);
                            return;
                        }
                        const dealsWithRelatedData = await Promise.all(fetchedDeals.map(async (deal) => {
                            const linkedContacts = (deal.contact_ids && deal.contact_ids.length > 0)
                                ? (await supabase.from('contacts').select('id, first_name, last_name, company').in('id', deal.contact_ids)).data || []
                                : [];

                            const { data: dealTagsData, error: dealTagsError } = await supabase
                                .from('deal_tags')
                                .select('tag_id, tags(id, name)')
                                .eq('deal_id', deal.id);

                            if (dealTagsError) {
                                console.error("Error fetching linked tags for deal:", dealTagsError);
                            }
                            const linkedTags = dealTagsData ? dealTagsData.map(dt => dt.tags) : [];
                            
                            return { ...deal, linkedContacts: linkedContacts, linkedTags: linkedTags };
                        }));
                        setDeals(dealsWithRelatedData);
                    });

                return () => {
                    statusesChannel.unsubscribe();
                    contactsChannel.unsubscribe();
                    tagsChannel.unsubscribe();
                    dealsChannel.unsubscribe();
                };
            }, [supabase, userId]);

            const handleDragStart = (e, dealId) => {
                e.dataTransfer.setData("dealId", dealId);
            };

            const handleDragOver = (e) => {
                e.preventDefault(); // Necessary to allow dropping
            };

            const handleDrop = async (e, newStatusId) => {
                e.preventDefault();
                const dealId = e.dataTransfer.getData("dealId");
                if (!dealId || !supabase || !userId) return;

                const dealToUpdate = deals.find(d => d.id === dealId);
                if (dealToUpdate && dealToUpdate.status_id !== newStatusId) {
                    try {
                        const { error } = await supabase
                            .from('deals')
                            .update({ status_id: newStatusId })
                            .eq('id', dealId);
                        if (error) throw error;
                        console.log(`Сделка ${dealId} перемещена в статус ${newStatusId}`);
                    } catch (error) {
                        console.error("Ошибка при обновлении статуса сделки:", error);
                    }
                }
            };

            const handleEditDeal = (deal) => {
                setEditingDeal(deal);
                setIsDealModalOpen(true);
            };

            const handleSaveDeal = async (dealData) => {
                try {
                    const { tag_ids, ...dealFields } = dealData; // Extract tag_ids
                    const dealToSave = {
                        name: dealFields.name,
                        amount: parseFloat(dealFields.amount),
                        status_id: dealFields.status_id,
                        owner_id: userId,
                        close_date: dealFields.close_date || null,
                        contact_ids: dealFields.contact_ids || [], 
                    };

                    let currentDealId = editingDeal ? editingDeal.id : null;

                    if (editingDeal) {
                        const { error } = await supabase
                            .from('deals')
                            .update(dealToSave)
                            .eq('id', editingDeal.id);
                        if (error) throw error;
                        console.log("Сделка обновлена:", editingDeal.id);
                    } else {
                        const { data, error } = await supabase
                            .from('deals')
                            .insert(dealToSave)
                            .select('id');
                        if (error) throw error;
                        currentDealId = data[0].id;
                        console.log("Новая сделка добавлена с ID:", currentDealId);
                    }

                    // Handle tags (delete existing and insert new ones)
                    if (currentDealId) {
                        const { error: deleteTagsError } = await supabase
                            .from('deal_tags')
                            .delete()
                            .eq('deal_id', currentDealId);
                        if (deleteTagsError) console.error("Error deleting old deal tags:", deleteTagsError);

                        if (tag_ids && tag_ids.length > 0) {
                            const newDealTags = tag_ids.map(tagId => ({
                                deal_id: currentDealId,
                                tag_id: tagId
                            }));
                            const { error: insertTagsError } = await supabase
                                .from('deal_tags')
                                .insert(newDealTags);
                            if (insertTagsError) console.error("Error inserting new deal tags:", insertTagsError);
                        }
                    }

                    setIsDealModalOpen(false);
                    setEditingDeal(null);
                } catch (e) {
                    console.error("Ошибка при сохранении сделки:", e);
                }
            };

            const handleViewDealDetails = (dealId) => {
                setSelectedDealId(dealId);
                setCurrentPage('dealDetails');
            };

            const getStatusName = (statusId) => {
                const status = statuses.find(s => s.id === statusId);
                return status ? status.name : 'Неизвестный статус';
            };

            return (
                <div className="p-6 bg-gray-50 min-h-screen rounded-lg shadow-inner">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6">Воронка продаж</h2>

                    {statuses.length === 0 ? (
                        <p className="text-center text-gray-600 text-lg mt-10">Загрузка статусов...</p>
                    ) : (
                        <div className="flex flex-col md:flex-row overflow-x-auto pb-4 space-x-6">
                            {statuses.map(status => (
                                <div
                                    key={status.id}
                                    onDragOver={handleDragOver}
                                    onDrop={(e) => handleDrop(e, status.id)}
                                    className="bg-white rounded-xl shadow-lg flex-shrink-0 w-full md:w-80 p-4 border-t-4"
                                    style={{ borderColor: status.color || '#6B7280' }}
                                >
                                    <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                                        {status.name}
                                        <span className="text-sm font-medium text-gray-500">
                                            ({deals.filter(d => d.status_id === status.id).length})
                                        </span>
                                    </h3>
                                    <div className="space-y-4 min-h-[100px]"> {/* min-h to make drop target visible */}
                                        {deals
                                            .filter(deal => deal.status_id === status.id)
                                            .map(deal => (
                                                <div
                                                    key={deal.id}
                                                    draggable
                                                    onDragStart={(e) => handleDragStart(e, deal.id)}
                                                    className="bg-gray-50 rounded-lg shadow-sm p-4 cursor-grab active:cursor-grabbing hover:shadow-md transition-shadow duration-200 border border-gray-200"
                                                >
                                                    <h4 className="font-semibold text-gray-800 text-lg mb-1">{deal.name}</h4>
                                                    <p className="text-gray-600 text-sm mb-1">Сумма: <span className="font-medium">${deal.amount?.toFixed(2)}</span></p>
                                                    {deal.linkedContacts && deal.linkedContacts.length > 0 && (
                                                        <p className="text-gray-500 text-xs">
                                                            Контакты: {deal.linkedContacts.map(c => `${c.first_name} ${c.last_name}`).join(', ')}
                                                        </p>
                                                    )}
                                                    {deal.linkedTags && deal.linkedTags.length > 0 && (
                                                        <div className="mt-2 flex flex-wrap gap-1">
                                                            {deal.linkedTags.map(tag => (
                                                                <span key={tag.id} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                                                                    {tag.name}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    )}
                                                    <div className="mt-3 text-right">
                                                        <button
                                                            onClick={() => handleViewDealDetails(deal.id)}
                                                            className="text-gray-600 hover:text-gray-800 text-sm font-medium mr-2"
                                                        >
                                                            Детали
                                                        </button>
                                                        <button
                                                            onClick={() => handleEditDeal(deal)}
                                                            className="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                                                        >
                                                            Редактировать
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        {deals.filter(d => d.status_id === status.id).length === 0 && (
                                            <p className="text-center text-gray-400 text-sm py-4">Перетащите сюда сделки</p>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    <Modal isOpen={isDealModalOpen} onClose={() => setIsDealModalOpen(false)} title={editingDeal ? "Редактировать сделку" : "Новая сделка"}>
                        <DealForm
                            deal={editingDeal}
                            contacts={contacts}
                            statuses={statuses}
                            tags={tags} // Pass tags to DealForm
                            onSave={handleSaveDeal}
                            onClose={() => setIsDealModalOpen(false)}
                        />
                    </Modal>
                </div>
            );
        };


        // --- New Analytics Page ---
        const AnalyticsPage = () => {
            const { supabase, userId } = useContext(AppContext);
            const [deals, setDeals] = useState([]);
            const [contacts, setContacts] = useState([]);
            const [interactions, setInteractions] = useState([]);
            const [statuses, setStatuses] = useState([]);


            useEffect(() => {
                if (!supabase || !userId) return;

                const fetchData = async () => {
                    try {
                        // Fetch deals
                        const { data: dealsData, error: dealsError } = await supabase
                            .from('deals')
                            .select('*')
                            .eq('owner_id', userId);
                        if (dealsError) console.error("Error fetching deals for dashboard:", dealsError);
                        else setDeals(dealsData);

                        // Fetch contacts
                        const { data: contactsData, error: contactsError } = await supabase
                            .from('contacts')
                            .select('*')
                            .eq('user_id', userId);
                        if (contactsError) console.error("Error fetching contacts for dashboard:", contactsError);
                        else setContacts(contactsData);

                        // Fetch interactions
                        const { data: interactionsData, error: interactionsError } = await supabase
                            .from('interactions')
                            .select('*')
                            .eq('user_id', userId);
                        if (interactionsError) console.error("Error fetching interactions for dashboard:", interactionsError);
                        else setInteractions(interactionsData);

                        // Fetch statuses
                        const { data: statusesData, error: statusesError } = await supabase
                            .from('deal_statuses')
                            .select('*')
                            .order('order_index');
                        if (statusesError) console.error("Error fetching statuses for dashboard:", statusesError);
                        else setStatuses(statusesData);

                    } catch (error) {
                        console.error("Error fetching analytics data:", error);
                    }
                };

                fetchData();
            }, [supabase, userId]);

            // Calculate metrics
            const totalDeals = deals.length;
            const totalContacts = contacts.length;
            const totalInteractions = interactions.length;
            const totalDealValue = deals.reduce((sum, deal) => sum + (deal.amount || 0), 0);

            const dealsByStatus = statuses.map(status => ({
                name: status.name,
                count: deals.filter(deal => deal.status_id === status.id).length,
                color: status.color
            }));

            const dealsWon = deals.filter(deal => {
                const wonStatus = statuses.find(s => s.name.toLowerCase().includes('выиграна') || s.name.toLowerCase().includes('won'));
                return wonStatus && deal.status_id === wonStatus.id;
            }).length;

            const dealsLost = deals.filter(deal => {
                const lostStatus = statuses.find(s => s.name.toLowerCase().includes('проиграна') || s.name.toLowerCase().includes('lost'));
                return lostStatus && deal.status_id === lostStatus.id;
            }).length;

            // Simple bar chart for deals by status (using div elements)
            const maxStatusCount = Math.max(...dealsByStatus.map(s => s.count), 1); // Avoid division by zero

            // Prepare data for new contacts over time
            const newContactsByMonth = contacts.reduce((acc, contact) => {
                if (contact.created_at) { // Supabase returns ISO string or Date object
                    const date = new Date(contact.created_at);
                    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    acc[monthYear] = (acc[monthYear] || 0) + 1;
                }
                return acc;
            }, {});

            const sortedContactMonths = Object.keys(newContactsByMonth).sort();
            const contactChartData = sortedContactMonths.map(month => ({
                month,
                count: newContactsByMonth[month]
            }));

            const maxContactCount = Math.max(...contactChartData.map(d => d.count), 1);

            return (
                <div className="p-6 bg-gray-50 min-h-screen rounded-lg shadow-inner">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6">Аналитика CRM</h2>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <StatCard title="Всего сделок" value={totalDeals} icon="📊" />
                        <StatCard title="Общая сумма сделок" value={`$${totalDealValue.toFixed(2)}`} icon="💰" />
                        <StatCard title="Выиграно сделок" value={dealsWon} icon="✅" />
                        <StatCard title="Проиграно сделок" value={dealsLost} icon="❌" />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Deals by Status Chart */}
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-bold text-gray-800 mb-4">Сделки по статусам</h3>
                            <div className="space-y-4">
                                {dealsByStatus.map(status => (
                                    <div key={status.name} className="flex items-center">
                                        <span className="w-32 text-sm font-medium text-gray-700">{status.name}</span>
                                        <div
                                            className="h-full rounded-full flex items-center justify-end pr-2 text-white text-xs font-bold transition-all duration-500 ease-out"
                                            style={{
                                                width: `${(status.count / maxStatusCount) * 100}%`,
                                                backgroundColor: status.color || '#6B7280'
                                            }}
                                        >
                                            {status.count > 0 && status.count}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* New Contacts Over Time Chart */}
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-bold text-gray-800 mb-4">Новые контакты по месяцам</h3>
                            {contactChartData.length === 0 ? (
                                <p className="text-center text-gray-600 py-8">Нет данных о новых контактах.</p>
                            ) : (
                                <div className="flex flex-col h-64 justify-end">
                                    <div className="flex items-end h-full border-b border-l border-gray-300 pb-1">
                                        {contactChartData.map((data, index) => (
                                            <div key={index} className="flex flex-col items-center flex-grow mx-1">
                                                <div
                                                    className="bg-indigo-500 rounded-t-md w-8 hover:bg-indigo-600 transition-colors duration-200"
                                                    style={{ height: `${(data.count / maxContactCount) * 90}%` }} // 90% of container height
                                                    title={`${data.month}: ${data.count}`}
                                                ></div>
                                                <span className="text-xs text-gray-600 mt-1">{data.month.split('-')[1]}</span> {/* Show only month */}
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex justify-between text-xs text-gray-500 mt-2">
                                        <span>Месяц</span>
                                        <span>Кол-во</span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Interactions Summary */}
                    <div className="bg-white rounded-xl shadow-lg p-6 mt-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-4">Сводка взаимодействий</h3>
                        <p className="text-gray-700">Всего зарегистрировано <span className="font-semibold text-indigo-600">{totalInteractions}</span> взаимодействий.</p>
                        {/* You can add more detailed breakdown here, e.g., by type */}
                    </div>
                </div>
            );
        };

        // --- New Contact Details Page ---
        const ContactDetailsPage = ({ contactId, onBack }) => {
            const { supabase, userId } = useContext(AppContext);
            const { setCurrentPage, setSelectedDealId } = useContext(AppRouterContext); // Get setSelectedDealId
            const [contact, setContact] = useState(null);
            const [linkedDeals, setLinkedDeals] = useState([]);
            const [linkedTasks, setLinkedTasks] = useState([]); // New state for tasks
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [statuses, setStatuses] = useState([]); // To display deal status names
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [users, setUsers] = useState([]); // For task assignee

            useEffect(() => {
                if (!supabase || !userId || !contactId) {
                    setLoading(false);
                    return;
                }

                const fetchData = async () => {
                    setLoading(true);
                    setError(null);
                    try {
                        // Fetch contact details
                        const { data: contactData, error: contactError } = await supabase
                            .from('contacts')
                            .select('*')
                            .eq('id', contactId)
                            .eq('user_id', userId) // Ensure user owns the contact
                            .single();

                        if (contactError) {
                            console.error("Error fetching contact details:", contactError);
                            setError("Не удалось загрузить детали контакта.");
                            setLoading(false);
                            return;
                        }
                        setContact(contactData);

                        // Fetch deals linked to this contact
                        const { data: dealsData, error: dealsError } = await supabase
                            .from('deals')
                            .select('*')
                            .eq('owner_id', userId);

                        if (dealsError) {
                            console.error("Error fetching linked deals:", dealsError);
                            setError("Не удалось загрузить связанные сделки.");
                            // Don't return, continue to fetch other data
                        } else {
                            const filteredDeals = dealsData.filter(deal => 
                                deal.contact_ids && Array.isArray(deal.contact_ids) && deal.contact_ids.includes(contactId)
                            );
                            setLinkedDeals(filteredDeals);
                        }

                        // Fetch tasks linked to this contact
                        const { data: tasksData, error: tasksError } = await supabase
                            .from('tasks')
                            .select('*, user(id, email)') // Select task and join with user table for assignee email
                            .eq('contact_id', contactId)
                            .or(`assigned_to_user_id.eq.${userId},deal_id.in.(${dealsData.map(d => d.id).join(',')})`); // Tasks assigned to current user OR linked to current user's deals
                        
                        if (tasksError) {
                            console.error("Error fetching linked tasks:", tasksError);
                        } else {
                            setLinkedTasks(tasksData);
                        }

                        // Fetch statuses for deal names
                        const { data: statusesData, error: statusesError } = await supabase
                            .from('deal_statuses')
                            .select('id, name, color')
                            .order('order_index');
                        if (statusesError) console.error("Error fetching statuses for contact details:", statusesError);
                        else setStatuses(statusesData);

                        // Fetch users for task assignee dropdown
                        const { data: usersData, error: usersError } = await supabase
                            .from('user')
                            .select('id, email');
                        if (usersError) console.error("Error fetching users for task form:", usersError);
                        else setUsers(usersData);


                    } catch (err) {
                        console.error("Unexpected error in ContactDetailsPage:", err);
                        setError("Произошла непредвиденная ошибка.");
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();
            }, [supabase, userId, contactId]);

            const getStatusName = (statusId) => {
                const status = statuses.find(s => s.id === statusId);
                return status ? status.name : 'Неизвестный статус';
            };

            const getStatusColor = (statusId) => {
                const status = statuses.find(s => s.id === statusId);
                return status ? status.color : '#6B7280'; // Default gray
            };

            const handleViewDealDetails = (dealId) => {
                setSelectedDealId(dealId);
                setCurrentPage('dealDetails');
            };

            const handleCreateTask = () => {
                setEditingTask({
                    title: '',
                    description: '',
                    due_date: '',
                    status: 'pending',
                    assigned_to_user_id: userId, // Default to current user
                    contact_id: contactId, // Automatically link to current contact
                    deal_id: null,
                });
                setIsTaskModalOpen(true);
            };

            const handleSaveTask = async (taskData) => {
                try {
                    const taskToSave = {
                        ...taskData,
                        assigned_to_user_id: taskData.assigned_to_user_id || userId, // Ensure assignee is set
                        due_date: taskData.due_date ? new Date(taskData.due_date).toISOString() : null,
                        contact_id: contactId, // Ensure it's linked to this contact
                        user_id: userId, // The user who created/owns this task entry (for RLS)
                    };

                    if (editingTask) {
                        const { error } = await supabase
                            .from('tasks')
                            .update(taskToSave)
                            .eq('id', editingTask.id);
                        if (error) throw error;
                        console.log("Задача обновлена:", editingTask.id);
                    } else {
                        const { error } = await supabase
                            .from('tasks')
                            .insert(taskToSave);
                        if (error) throw error;
                        console.log("Новая задача добавлена.");
                    }
                    setIsTaskModalOpen(false);
                    setEditingTask(null);
                    // Re-fetch tasks to update the list
                    const { data: tasksData, error: tasksError } = await supabase
                        .from('tasks')
                        .select('*, user(id, email)')
                        .eq('contact_id', contactId)
                        .or(`assigned_to_user_id.eq.${userId},deal_id.in.(${linkedDeals.map(d => d.id).join(',')})`); // Re-fetch based on current deals
                    if (tasksError) console.error("Error re-fetching tasks after save:", tasksError);
                    else setLinkedTasks(tasksData);

                } catch (e) {
                    console.error("Ошибка при сохранении задачи:", e);
                }
            };


            if (loading) {
                return <div className="p-6 text-center text-gray-600">Загрузка деталей контакта...</div>;
            }

            if (error) {
                return <div className="p-6 text-center text-red-600">Ошибка: {error}</div>;
            }

            if (!contact) {
                return <div className="p-6 text-center text-gray-600">Контакт не найден.</div>;
            }

            return (
                <div className="p-6 bg-gray-50 min-h-screen rounded-lg shadow-inner">
                    <button
                        onClick={onBack}
                        className="mb-6 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150 flex items-center"
                    >
                        <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Назад к контактам
                    </button>

                    <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <h2 className="text-3xl font-extrabold text-gray-900 mb-4 border-b pb-2">
                            {contact.first_name} {contact.last_name}
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                            <p><span className="font-semibold">Компания:</span> {contact.company || 'N/A'}</p>
                            <p><span className="font-semibold">Должность:</span> {contact.title || 'N/A'}</p>
                            <p><span className="font-semibold">Email:</span> <a href={`mailto:${contact.email}`} className="text-indigo-600 hover:underline">{contact.email || 'N/A'}</a></p>
                            <p><span className="font-semibold">Телефон:</span> <a href={`tel:${contact.phone}`} className="text-indigo-600 hover:underline">{contact.phone || 'N/A'}</a></p>
                            <p><span className="font-semibold">Создан:</span> {new Date(contact.created_at).toLocaleDateString()}</p>
                            <p><span className="font-semibold">ID пользователя:</span> <span className="break-all">{contact.user_id || 'N/A'}</span></p>
                        </div>
                    </div>

                    <h3 className="text-2xl font-bold text-gray-900 mb-4">Связанные сделки</h3>
                    {linkedDeals.length === 0 ? (
                        <p className="text-center text-gray-600 text-lg mt-6">Нет связанных сделок.</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {linkedDeals.map(deal => (
                                <div
                                    key={deal.id}
                                    onClick={() => handleViewDealDetails(deal.id)} // Make clickable
                                    className="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition-shadow duration-300"
                                >
                                    <div className="flex justify-between items-start mb-2">
                                        <h4 className="text-xl font-bold text-gray-800">{deal.name}</h4>
                                        <span
                                            className="px-3 py-1 rounded-full text-xs font-semibold"
                                            style={{ backgroundColor: getStatusColor(deal.status_id), color: 'white' }}
                                        >
                                            {getStatusName(deal.status_id)}
                                        </span>
                                    </div>
                                    <p className="text-gray-600 mb-1">Сумма: <span className="font-semibold text-green-700">${deal.amount?.toFixed(2)}</span></p>
                                    <p className="text-gray-600 text-sm">Дата закрытия: {deal.close_date ? new Date(deal.close_date).toLocaleDateString() : 'N/A'}</p>
                                </div>
                            ))}
                        </div>
                    )}

                    <div className="mt-8">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-2xl font-bold text-gray-900">Задачи</h3>
                            <button
                                onClick={handleCreateTask}
                                className="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out flex items-center text-sm"
                            >
                                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Новая задача
                            </button>
                        </div>
                        {linkedTasks.length === 0 ? (
                            <p className="text-center text-gray-600 text-lg mt-6">Нет связанных задач.</p>
                        ) : (
                            <div className="space-y-4">
                                {linkedTasks.map(task => (
                                    <div key={task.id} className="bg-white rounded-xl shadow-lg p-4">
                                        <h4 className="font-semibold text-gray-800 text-lg">{task.title}</h4>
                                        <p className="text-gray-600 text-sm">{task.description}</p>
                                        <p className="text-gray-500 text-xs mt-1">
                                            Срок: {task.due_date ? new Date(task.due_date).toLocaleDateString() : 'N/A'} |
                                            Статус: <span className="font-medium capitalize">{task.status}</span> |
                                            Ответственный: {task.user ? task.user.email : 'N/A'}
                                        </p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <Modal isOpen={isTaskModalOpen} onClose={() => setIsTaskModalOpen(false)} title={editingTask ? "Редактировать задачу" : "Новая задача"}>
                        <TaskForm
                            task={editingTask}
                            contacts={[{ id: contactId, first_name: contact.first_name, last_name: contact.last_name, company: contact.company }]} // Pass only current contact
                            deals={linkedDeals} // Pass linked deals
                            users={users} // Pass all users for assignee
                            onSave={handleSaveTask}
                            onClose={() => setIsTaskModalOpen(false)}
                        />
                    </Modal>
                </div>
            );
        };

        // --- New Deal Details Page ---
        const DealDetailsPage = ({ dealId, onBack }) => {
            const { supabase, userId } = useContext(AppContext);
            const { setCurrentPage, setSelectedContactId } = useContext(AppRouterContext); // Get setSelectedContactId
            const [deal, setDeal] = useState(null);
            const [auditLogs, setAuditLogs] = useState([]);
            const [linkedContacts, setLinkedContacts] = useState([]);
            const [linkedTags, setLinkedTags] = useState([]);
            const [linkedTasks, setLinkedTasks] = useState([]); // New state for tasks
            const [statuses, setStatuses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [users, setUsers] = useState([]); // For task assignee

            useEffect(() => {
                if (!supabase || !userId || !dealId) {
                    setLoading(false);
                    return;
                }

                const fetchData = async () => {
                    setLoading(true);
                    setError(null);
                    try {
                        // Fetch deal details
                        const { data: dealData, error: dealError } = await supabase
                            .from('deals')
                            .select('*')
                            .eq('id', dealId)
                            .eq('owner_id', userId) // Ensure user owns the deal
                            .single();

                        if (dealError) {
                            console.error("Error fetching deal details:", dealError);
                            setError("Не удалось загрузить детали сделки.");
                            setLoading(false);
                            return;
                        }
                        setDeal(dealData);

                        // Fetch audit logs for this deal
                        const { data: logsData, error: logsError } = await supabase
                            .from('deal_audit_logs')
                            .select('*')
                            .eq('deal_id', dealId)
                            .order('changed_at', { ascending: false }); // Latest changes first

                        if (logsError) {
                            console.error("Error fetching audit logs:", logsError);
                            // Don't block if logs fail, just show what we have
                        } else {
                            setAuditLogs(logsData);
                        }

                        // Fetch linked contacts
                        if (dealData.contact_ids && dealData.contact_ids.length > 0) {
                            const { data: contactsData, error: contactsError } = await supabase
                                .from('contacts')
                                .select('id, first_name, last_name, company')
                                .in('id', dealData.contact_ids);
                            if (contactsError) console.error("Error fetching linked contacts for deal details:", contactsError);
                            else setLinkedContacts(contactsData);
                        }

                        // Fetch linked tags
                        const { data: dealTagsData, error: dealTagsError } = await supabase
                            .from('deal_tags')
                            .select('tag_id, tags(id, name)')
                            .eq('deal_id', dealId);

                        if (dealTagsError) {
                            console.error("Error fetching linked tags for deal details:", dealTagsError);
                        }
                        const tags = dealTagsData ? dealTagsData.map(dt => dt.tags) : [];
                        setLinkedTags(tags);

                        // Fetch tasks linked to this deal
                        const { data: tasksData, error: tasksError } = await supabase
                            .from('tasks')
                            .select('*, user(id, email)') // Select task and join with user table for assignee email
                            .eq('deal_id', dealId)
                            .eq('assigned_to_user_id', userId); // Only tasks assigned to current user for RLS

                        if (tasksError) {
                            console.error("Error fetching linked tasks:", tasksError);
                        } else {
                            setLinkedTasks(tasksData);
                        }

                        // Fetch statuses for display
                        const { data: statusesData, error: statusesError } = await supabase
                            .from('deal_statuses')
                            .select('id, name, color')
                            .order('order_index');
                        if (statusesError) console.error("Error fetching statuses for deal details:", statusesError);
                        else setStatuses(statusesData);

                        // Fetch users for task assignee dropdown
                        const { data: usersData, error: usersError } = await supabase
                            .from('user')
                            .select('id, email');
                        if (usersError) console.error("Error fetching users for task form:", usersError);
                        else setUsers(usersData);


                    } catch (err) {
                        console.error("Unexpected error in DealDetailsPage:", err);
                        setError("Произошла непредвиденная ошибка.");
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();
            }, [supabase, userId, dealId]);

            const getStatusName = (statusId) => {
                const status = statuses.find(s => s.id === statusId);
                return status ? status.name : 'Неизвестный статус';
            };

            const getStatusColor = (statusId) => {
                const status = statuses.find(s => s.id === statusId);
                return status ? status.color : '#6B7280'; // Default gray
            };

            const handleViewContactDetails = (contactId) => {
                setSelectedContactId(contactId);
                setCurrentPage('contactDetails');
            };

            const handleCreateTask = () => {
                setEditingTask({
                    title: '',
                    description: '',
                    due_date: '',
                    status: 'pending',
                    assigned_to_user_id: userId, // Default to current user
                    deal_id: dealId, // Automatically link to current deal
                    contact_id: null,
                });
                setIsTaskModalOpen(true);
            };

            const handleSaveTask = async (taskData) => {
                try {
                    const taskToSave = {
                        ...taskData,
                        assigned_to_user_id: taskData.assigned_to_user_id || userId, // Ensure assignee is set
                        due_date: taskData.due_date ? new Date(taskData.due_date).toISOString() : null,
                        deal_id: dealId, // Ensure it's linked to this deal
                        user_id: userId, // The user who created/owns this task entry (for RLS)
                    };

                    if (editingTask) {
                        const { error } = await supabase
                            .from('tasks')
                            .update(taskToSave)
                            .eq('id', editingTask.id);
                        if (error) throw error;
                        console.log("Задача обновлена:", editingTask.id);
                    } else {
                        const { error } = await supabase
                            .from('tasks')
                            .insert(taskToSave);
                        if (error) throw error;
                        console.log("Новая задача добавлена.");
                    }
                    setIsTaskModalOpen(false);
                    setEditingTask(null);
                    // Re-fetch tasks to update the list
                    const { data: tasksData, error: tasksError } = await supabase
                        .from('tasks')
                        .select('*, user(id, email)')
                        .eq('deal_id', dealId)
                        .eq('assigned_to_user_id', userId); // Re-fetch based on current user's assigned tasks
                    if (tasksError) console.error("Error re-fetching tasks after save:", tasksError);
                    else setLinkedTasks(tasksData);

                } catch (e) {
                    console.error("Ошибка при сохранении задачи:", e);
                }
            };


            if (loading) {
                return <div className="p-6 text-center text-gray-600">Загрузка деталей сделки...</div>;
            }

            if (error) {
                return <div className="p-6 text-center text-red-600">Ошибка: {error}</div>;
            }

            if (!deal) {
                return <div className="p-6 text-center text-gray-600">Сделка не найдена или у вас нет доступа.</div>;
            }

            return (
                <div className="p-6 bg-gray-50 min-h-screen rounded-lg shadow-inner">
                    <button
                        onClick={onBack}
                        className="mb-6 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150 flex items-center"
                    >
                        <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Назад к сделкам
                    </button>

                    <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <h2 className="text-3xl font-extrabold text-gray-900 mb-4 border-b pb-2">
                            {deal.name}
                            <span
                                className="ml-4 px-3 py-1 rounded-full text-sm font-semibold"
                                style={{ backgroundColor: getStatusColor(deal.status_id), color: 'white' }}
                            >
                                {getStatusName(deal.status_id)}
                            </span>
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 mb-6">
                            <p><span className="font-semibold">Сумма:</span> ${deal.amount?.toFixed(2) || '0.00'}</p>
                            <p><span className="font-semibold">Дата закрытия:</span> {deal.close_date ? new Date(deal.close_date).toLocaleDateString() : 'N/A'}</p>
                            <p><span className="font-semibold">Создана:</span> {new Date(deal.created_at).toLocaleDateString()}</p>
                            <p><span className="font-semibold">Последнее обновление:</span> {new Date(deal.updated_at).toLocaleDateString()}</p>
                            <p><span className="font-semibold">Владелец:</span> <span className="break-all">{deal.owner_id || 'N/A'}</span></p>
                        </div>

                        {linkedContacts && linkedContacts.length > 0 && (
                            <div className="mb-6">
                                <h3 className="text-xl font-bold text-gray-800 mb-2">Связанные контакты:</h3>
                                <ul className="list-disc list-inside text-gray-700">
                                    {linkedContacts.map(contact => (
                                        <li key={contact.id}>
                                            <button
                                                onClick={() => handleViewContactDetails(contact.id)}
                                                className="text-indigo-600 hover:underline text-left"
                                            >
                                                {contact.first_name} {contact.last_name} ({contact.company})
                                            </button>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {linkedTags && linkedTags.length > 0 && (
                            <div className="mb-6">
                                <h3 className="text-xl font-bold text-gray-800 mb-2">Теги:</h3>
                                <div className="flex flex-wrap gap-2">
                                    {linkedTags.map(tag => (
                                        <span key={tag.id} className="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
                                            {tag.name}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="mt-8">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-2xl font-bold text-gray-900">Задачи</h3>
                            <button
                                onClick={handleCreateTask}
                                className="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out flex items-center text-sm"
                            >
                                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Новая задача
                            </button>
                        </div>
                        {linkedTasks.length === 0 ? (
                            <p className="text-center text-gray-600 text-lg mt-6">Нет связанных задач.</p>
                        ) : (
                            <div className="space-y-4">
                                {linkedTasks.map(task => (
                                    <div key={task.id} className="bg-white rounded-xl shadow-lg p-4">
                                        <h4 className="font-semibold text-gray-800 text-lg">{task.title}</h4>
                                        <p className="text-gray-600 text-sm">{task.description}</p>
                                        <p className="text-gray-500 text-xs mt-1">
                                            Срок: {task.due_date ? new Date(task.due_date).toLocaleDateString() : 'N/A'} |
                                            Статус: <span className="font-medium capitalize">{task.status}</span> |
                                            Ответственный: {task.user ? task.user.email : 'N/A'}
                                        </p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <h3 className="text-2xl font-bold text-gray-900 mb-4 mt-8">Журнал изменений</h3>
                    {auditLogs.length === 0 ? (
                        <p className="text-center text-gray-600 text-lg mt-6">Нет записей об изменениях для этой сделки.</p>
                    ) : (
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Дата/Время
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Поле
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Старое значение
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Новое значение
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Пользователь
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {auditLogs.map(log => (
                                            <tr key={log.id}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                                                    {new Date(log.changed_at).toLocaleString()}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                                                    {log.field_name}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                                                    {log.old_value || 'NULL'}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                                                    {log.new_value || 'NULL'}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                                                    {log.user_id || 'Система'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    <Modal isOpen={isTaskModalOpen} onClose={() => setIsTaskModalOpen(false)} title={editingTask ? "Редактировать задачу" : "Новая задача"}>
                        <TaskForm
                            task={editingTask}
                            contacts={linkedContacts} // Pass linked contacts
                            deals={[{ id: dealId, name: deal.name }]} // Pass only current deal
                            users={users} // Pass all users for assignee
                            onSave={handleSaveTask}
                            onClose={() => setIsTaskModalOpen(false)}
                        />
                    </Modal>
                </div>
            );
        };

        const TaskForm = ({ task, contacts, deals, users, onSave, onClose }) => {
            const [formData, setFormData] = useState(task || {
                title: '',
                description: '',
                due_date: '',
                status: 'pending',
                assigned_to_user_id: '',
                deal_id: '',
                contact_id: ''
            });

            useEffect(() => {
                if (task) {
                    setFormData({
                        ...task,
                        due_date: task.due_date ? new Date(task.due_date).toISOString().split('T')[0] : '',
                    });
                }
            }, [task]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            const statusOptions = [
                { value: 'pending', label: 'В ожидании' },
                { value: 'completed', label: 'Завершено' },
                { value: 'cancelled', label: 'Отменено' }
            ];

            const userOptions = users.map(u => ({ value: u.id, label: u.email }));
            const dealOptions = deals.map(d => ({ value: d.id, label: d.name }));
            const contactOptions = contacts.map(c => ({ value: c.id, label: `${c.first_name} ${c.last_name}` }));

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <InputField label="Название задачи" id="title" value={formData.title} onChange={handleChange} placeholder="Название задачи" />
                    <TextAreaField label="Описание" id="description" value={formData.description} onChange={handleChange} placeholder="Подробное описание задачи" />
                    <InputField label="Срок" id="due_date" type="date" value={formData.due_date} onChange={handleChange} />
                    <SelectField
                        label="Статус"
                        id="status"
                        value={formData.status}
                        onChange={handleChange}
                        options={statusOptions}
                    />
                    <SelectField
                        label="Ответственный"
                        id="assigned_to_user_id"
                        value={formData.assigned_to_user_id}
                        onChange={handleChange}
                        options={[{ value: '', label: 'Выберите менеджера' }, ...userOptions]}
                    />
                    <SelectField
                        label="Привязать к сделке"
                        id="deal_id"
                        value={formData.deal_id || ''}
                        onChange={handleChange}
                        options={[{ value: '', label: 'Не привязано' }, ...dealOptions]}
                    />
                    <SelectField
                        label="Привязать к контакту"
                        id="contact_id"
                        value={formData.contact_id || ''}
                        onChange={handleChange}
                        options={[{ value: '', label: 'Не привязано' }, ...contactOptions]}
                    />

                    <div className="flex justify-end space-x-3 mt-6">
                        <button
                            type="button"
                            onClick={onClose}
                            className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150 ease-in-out"
                        >
                            Отмена
                        </button>
                        <button
                            type="submit"
                            className="px-6 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out"
                        >
                            Сохранить задачу
                        </button>
                    </div>
                </form>
            );
        };

        const TasksPage = () => {
            const { supabase, userId } = useContext(AppContext);
            const { setCurrentPage, setSelectedDealId, setSelectedContactId } = useContext(AppRouterContext);
            const [tasks, setTasks] = useState([]);
            const [users, setUsers] = useState([]); // For displaying assignee names
            const [deals, setDeals] = useState([]); // For displaying linked deal names
            const [contacts, setContacts] = useState([]); // For displaying linked contact names
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [taskToDelete, setTaskToDelete] = useState(null);

            useEffect(() => {
                if (!supabase || !userId) return;

                const fetchRelatedData = async () => {
                    // Fetch all users for assignee display
                    const { data: usersData, error: usersError } = await supabase
                        .from('user')
                        .select('id, email');
                    if (usersError) console.error("Error fetching users for tasks page:", usersError);
                    else setUsers(usersData);

                    // Fetch all deals for linking display
                    const { data: dealsData, error: dealsError } = await supabase
                        .from('deals')
                        .select('id, name')
                        .eq('owner_id', userId); // Only deals owned by current user
                    if (dealsError) console.error("Error fetching deals for tasks page:", dealsError);
                    else setDeals(dealsData);

                    // Fetch all contacts for linking display
                    const { data: contactsData, error: contactsError } = await supabase
                        .from('contacts')
                        .select('id, first_name, last_name')
                        .eq('user_id', userId); // Only contacts owned by current user
                    if (contactsError) console.error("Error fetching contacts for tasks page:", contactsError);
                    else setContacts(contactsData);
                };

                fetchRelatedData();

                // Real-time subscription for tasks
                const tasksChannel = supabase.channel('tasks_changes')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'tasks' },
                        async payload => {
                            console.log("Real-time update for tasks:", payload);
                            const { data: fetchedTasks, error } = await supabase
                                .from('tasks')
                                .select('*, user(id, email)') // Join with user table for assignee email
                                .eq('assigned_to_user_id', userId); // Only tasks assigned to current user (for RLS)

                            if (error) console.error("Error re-fetching tasks:", error);
                            else setTasks(fetchedTasks);
                        }
                    )
                    .subscribe();

                // Initial fetch for tasks
                supabase.from('tasks')
                    .select('*, user(id, email)') // Join with user table for assignee email
                    .eq('assigned_to_user_id', userId) // Only tasks assigned to current user (for RLS)
                    .order('due_date', { ascending: true, nullsFirst: false })
                    .then(({ data, error }) => {
                        if (error) console.error("Error fetching initial tasks:", error);
                        else setTasks(data);
                    });

                return () => tasksChannel.unsubscribe();
            }, [supabase, userId]);

            const getAssigneeEmail = (userId) => {
                const user = users.find(u => u.id === userId);
                return user ? user.email : 'N/A';
            };

            const getDealName = (dealId) => {
                const deal = deals.find(d => d.id === dealId);
                return deal ? deal.name : 'N/A';
            };

            const getContactName = (contactId) => {
                const contact = contacts.find(c => c.id === contactId);
                return contact ? `${contact.first_name} ${contact.last_name}` : 'N/A';
            };

            const handleSaveTask = async (taskData) => {
                try {
                    const taskToSave = {
                        ...taskData,
                        assigned_to_user_id: taskData.assigned_to_user_id || userId, // Ensure assignee is set
                        due_date: taskData.due_date ? new Date(taskData.due_date).toISOString() : null,
                        user_id: userId, // The user who created/owns this task entry (for RLS)
                    };

                    if (editingTask) {
                        const { error } = await supabase
                            .from('tasks')
                            .update(taskToSave)
                            .eq('id', editingTask.id);
                        if (error) throw error;
                        console.log("Задача обновлена:", editingTask.id);
                    } else {
                        const { error } = await supabase
                            .from('tasks')
                            .insert(taskToSave);
                        if (error) throw error;
                        console.log("Новая задача добавлена.");
                    }
                    setIsTaskModalOpen(false);
                    setEditingTask(null);
                } catch (e) {
                    console.error("Ошибка при сохранении задачи:", e);
                }
            };

            const handleEditTask = (task) => {
                setEditingTask(task);
                setIsTaskModalOpen(true);
            };

            const handleDeleteClick = (task) => {
                setTaskToDelete(task);
                setShowDeleteConfirm(true);
            };

            const confirmDeleteTask = async () => {
                if (!taskToDelete) return;
                try {
                    const { error } = await supabase
                        .from('tasks')
                        .delete()
                        .eq('id', taskToDelete.id);
                    if (error) throw error;
                    console.log("Задача удалена:", taskToDelete.id);
                    setShowDeleteConfirm(false);
                    setTaskToDelete(null);
                } catch (e) {
                    console.error("Ошибка при удалении задачи:", e);
                }
            };

            return (
                <div className="p-6 bg-gray-50 min-h-screen rounded-lg shadow-inner">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-extrabold text-gray-900">Задачи</h2>
                        <button
                            onClick={() => { setEditingTask(null); setIsTaskModalOpen(true); }}
                            className="px-6 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out flex items-center"
                        >
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            Новая задача
                        </button>
                    </div>

                    {tasks.length === 0 ? (
                        <p className="text-center text-gray-600 text-lg mt-10">Пока нет задач. Создай первую!</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {tasks.map(task => (
                                <div key={task.id} className="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                                    <div className="p-6">
                                        <div className="flex justify-between items-start mb-3">
                                            <h3 className="text-xl font-bold text-gray-800">{task.title}</h3>
                                            <span className={`px-3 py-1 rounded-full text-xs font-semibold capitalize
                                                ${task.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                                  task.status === 'completed' ? 'bg-green-100 text-green-800' :
                                                  'bg-gray-100 text-gray-800'}`
                                            }>
                                                {task.status}
                                            </span>
                                        </div>
                                        <p className="text-gray-600 mb-2 text-sm">{task.description}</p>
                                        <p className="text-gray-600 mb-1">Срок: <span className="font-semibold">{task.due_date ? new Date(task.due_date).toLocaleDateString() : 'N/A'}</span></p>
                                        <p className="text-gray-600 mb-1">Ответственный: <span className="font-semibold">{getAssigneeEmail(task.assigned_to_user_id)}</span></p>
                                        {task.deal_id && (
                                            <p className="text-gray-600 mb-1">Сделка: <span className="font-semibold">
                                                <button onClick={() => { setSelectedDealId(task.deal_id); setCurrentPage('dealDetails'); }} className="text-indigo-600 hover:underline">
                                                    {getDealName(task.deal_id)}
                                                </button>
                                            </span></p>
                                        )}
                                        {task.contact_id && (
                                            <p className="text-gray-600 mb-1">Контакт: <span className="font-semibold">
                                                <button onClick={() => { setSelectedContactId(task.contact_id); setCurrentPage('contactDetails'); }} className="text-indigo-600 hover:underline">
                                                    {getContactName(task.contact_id)}
                                                </button>
                                            </span></p>
                                        )}
                                    </div>
                                    <div className="bg-gray-50 border-t border-gray-100 px-6 py-4 flex justify-end space-x-2">
                                        <button
                                            onClick={() => handleEditTask(task)}
                                            className="text-indigo-600 hover:text-indigo-800 font-medium text-sm px-3 py-1 rounded-lg hover:bg-indigo-50 transition duration-150"
                                        >
                                            Редактировать
                                        </button>
                                        <button
                                            onClick={() => handleDeleteClick(task)}
                                            className="text-red-600 hover:text-red-800 font-medium text-sm px-3 py-1 rounded-lg hover:bg-red-50 transition duration-150"
                                        >
                                            Удалить
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    <Modal isOpen={isTaskModalOpen} onClose={() => setIsTaskModalOpen(false)} title={editingTask ? "Редактировать задачу" : "Новая задача"}>
                        <TaskForm
                            task={editingTask}
                            contacts={contacts}
                            deals={deals}
                            users={users}
                            onSave={handleSaveTask}
                            onClose={() => setIsTaskModalOpen(false)}
                        />
                    </Modal>

                    <Modal isOpen={showDeleteConfirm} onClose={() => setIsTaskModalOpen(false)} title="Подтверждение удаления">
                        <p className="text-gray-700 mb-6">Вы уверены, что хотите удалить задачу "{taskToDelete?.title}"? Это действие необратимо.</p>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={() => setShowDeleteConfirm(false)}
                                className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150"
                            >
                                Отмена
                            </button>
                            <button
                                type="button"
                                onClick={confirmDeleteTask}
                                className="px-6 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out"
                            >
                                Удалить
                            </button>
                        </div>
                    </Modal>
                </div>
            );
        };


        const AppRouterContext = createContext(null);

        const App = () => {
            const [currentPage, setCurrentPage] = useState('dashboard'); // 'dashboard', 'deals', 'contacts', 'history', 'integrations', 'funnel', 'analytics', 'contactDetails', 'dealDetails', 'tasks'
            const [selectedContactId, setSelectedContactId] = useState(null); // State for ContactDetailsPage
            const [selectedDealId, setSelectedDealId] = useState(null); // State for DealDetailsPage
            const { userId } = useContext(AppContext); // Get userId from AppContext

            const NavItem = ({ page, label, icon }) => (
                <button
                    onClick={() => {
                        setCurrentPage(page);
                        setSelectedContactId(null); // Reset selected contact when changing page
                        setSelectedDealId(null); // Reset selected deal when changing page
                    }}
                    className={`flex items-center space-x-3 px-4 py-2 rounded-lg transition-all duration-200
                                ${currentPage === page ? 'bg-indigo-700 text-white shadow-md' : 'text-indigo-200 hover:bg-indigo-600 hover:text-white'}`}
                >
                    <span className="text-2xl">{icon}</span>
                    <span className="font-medium text-lg hidden md:inline">{label}</span>
                </button>
            );

            const renderPage = () => {
                switch (currentPage) {
                    case 'dashboard':
                        return <DashboardPage />;
                    case 'deals':
                        return <DealsPage />;
                    case 'funnel':
                        return <FunnelPage />;
                    case 'contacts':
                        return <ContactsPage />;
                    case 'history':
                        return <HistoryPage />;
                    case 'integrations':
                        return <IntegrationsPage />;
                    case 'analytics':
                        return <AnalyticsPage />;
                    case 'tasks':
                        return <TasksPage />; // New Tasks page
                    case 'contactDetails':
                        return <ContactDetailsPage contactId={selectedContactId} onBack={() => setCurrentPage('contacts')} />;
                    case 'dealDetails':
                        return <DealDetailsPage dealId={selectedDealId} onBack={() => setCurrentPage('deals')} />;
                    default:
                        return <DashboardPage />;
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-900 flex flex-col md:flex-row">
                    {/* Sidebar / Navigation */}
                    <nav className="bg-indigo-800 text-white p-4 md:p-6 flex flex-row md:flex-col items-center md:items-stretch justify-around md:justify-start shadow-xl md:shadow-none md:w-64 flex-shrink-0">
                        <div className="text-3xl font-extrabold mb-0 md:mb-10 text-center hidden md:block">
                            CRM 2025
                        </div>
                        <div className="flex flex-row md:flex-col space-x-4 md:space-x-0 md:space-y-4 w-full justify-center md:justify-start">
                            <NavItem page="dashboard" label="Панель управления" icon="🏠" />
                            <NavItem page="deals" label="Сделки" icon="🤝" />
                            <NavItem page="funnel" label="Воронка" icon="📈" />
                            <NavItem page="contacts" label="Контакты" icon="👤" />
                            <NavItem page="tasks" label="Задачи" icon="✅" /> {/* New Nav Item */}
                            <NavItem page="history" label="История" icon="📚" />
                            <NavItem page="integrations" label="Интеграции" icon="🔌" />
                            <NavItem page="analytics" label="Аналитика" icon="📊" />
                        </div>
                        <div className="mt-auto pt-6 text-sm text-indigo-300 hidden md:block">
                            <p className="text-center">Ваш ID пользователя:</p>
                            <p className="text-center break-all font-mono text-xs">{userId || 'Загрузка...'}</p>
                        </div>
                    </nav>

                    {/* Main Content Area */}
                    <main className="flex-grow p-4 md:p-8">
                        <AppRouterContext.Provider value={{ setCurrentPage, setSelectedContactId, setSelectedDealId }}>
                            {renderPage()}
                        </AppRouterContext.Provider>
                    </main>
                </div>
            );
        };

        // Render the main App component into the root div
        ReactDOM.render(
            <AppProvider>
                <App />
            </AppProvider>,
            document.getElementById('root')
        );
    </script>
</body>
</html>
